<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoltar - Devineur de Chiffres</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
            color: #667eea;
            font-weight: bold;
        }
        
        .subtitle {
            text-align: center;
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 20px;
        }
        
        .section {
            background: #f7fafc;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2d3748;
        }
        
        select {
            width: 100%;
            padding: 10px;
            background: white;
            color: #2d3748;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .tools {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        button {
            flex: 1;
            padding: 10px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        button.active {
            background: #667eea;
            color: white;
        }
        
        #drawingCanvas {
            width: 100%;
            height: 280px;
            border: 3px solid #667eea;
            border-radius: 10px;
            cursor: crosshair;
            background: #000000;
            touch-action: none;
        }
        
        .result {
            text-align: center;
        }
        
        .prediction {
            font-size: 64px;
            font-weight: bold;
            margin: 10px 0;
            color: #667eea;
        }
        
        .confidence {
            font-size: 18px;
            color: #4a5568;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .probabilities {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 200px;
            border-bottom: 2px solid #2d3748;
            padding: 0 10px;
            margin-top: 20px;
        }
        
        .prob-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 50px;
        }
        
        .prob-value {
            font-size: 11px;
            color: #4a5568;
            margin-bottom: 5px;
            font-weight: 500;
            min-height: 16px;
        }
        
        .prob-bar-container {
            width: 100%;
            height: 150px;
            display: flex;
            align-items: flex-end;
        }
        
        .prob-bar {
            width: 100%;
            background: linear-gradient(180deg, #764ba2, #667eea);
            border-radius: 5px 5px 0 0;
            transition: height 0.5s ease;
            height: 0%;
        }
        
        .prob-label {
            font-weight: bold;
            color: #2d3748;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .status {
            text-align: center;
            font-size: 12px;
            color: #718096;
            margin-top: 10px;
            min-height: 18px;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .prediction {
                font-size: 48px;
            }
            
            #drawingCanvas {
                height: 250px;
            }
            
            .probabilities {
                height: 150px;
            }
            
            .prob-bar-container {
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Zoltar Devineur de Chiffres</h1>
        <p class="subtitle">Dessinez un chiffre en blanc sur le canvas</p>
        
        <div class="section">
            <label>Modele :</label>
            <select id="modelSelect">
                <option value="mnist_mlp">MLP</option>
                <option value="mnist_convnet">CNN</option>
            </select>
        </div>
        
        <div class="section">
            <div class="tools">
                <button id="penBtn" class="active">Stylo</button>
                <button id="eraserBtn">Gomme</button>
                <button id="clearBtn">Effacer</button>
            </div>
            <canvas id="drawingCanvas"></canvas>
        </div>
        
        <div class="section result">
            <div class="prediction" id="prediction">-</div>
            <div class="confidence" id="confidence">Chargement...</div>
            <div class="status" id="status"></div>
            
            <div class="probabilities">
                <div class="prob-col">
                    <div class="prob-value" id="prob0">0%</div>
                    <div class="prob-bar-container">
                        <div class="prob-bar" id="bar0"></div>
                    </div>
                    <div class="prob-label">0</div>
                </div>
                <div class="prob-col">
                    <div class="prob-value" id="prob1">0%</div>
                    <div class="prob-bar-container">
                        <div class="prob-bar" id="bar1"></div>
                    </div>
                    <div class="prob-label">1</div>
                </div>
                <div class="prob-col">
                    <div class="prob-value" id="prob2">0%</div>
                    <div class="prob-bar-container">
                        <div class="prob-bar" id="bar2"></div>
                    </div>
                    <div class="prob-label">2</div>
                </div>
                <div class="prob-col">
                    <div class="prob-value" id="prob3">0%</div>
                    <div class="prob-bar-container">
                        <div class="prob-bar" id="bar3"></div>
                    </div>
                    <div class="prob-label">3</div>
                </div>
                <div class="prob-col">
                    <div class="prob-value" id="prob4">0%</div>
                    <div class="prob-bar-container">
                        <div class="prob-bar" id="bar4"></div>
                    </div>
                    <div class="prob-label">4</div>
                </div>
                <div class="prob-col">
                    <div class="prob-value" id="prob5">0%</div>
                    <div class="prob-bar-container">
                        <div class="prob-bar" id="bar5"></div>
                    </div>
                    <div class="prob-label">5</div>
                </div>
                <div class="prob-col">
                    <div class="prob-value" id="prob6">0%</div>
                    <div class="prob-bar-container">
                        <div class="prob-bar" id="bar6"></div>
                    </div>
                    <div class="prob-label">6</div>
                </div>
                <div class="prob-col">
                    <div class="prob-value" id="prob7">0%</div>
                    <div class="prob-bar-container">
                        <div class="prob-bar" id="bar7"></div>
                    </div>
                    <div class="prob-label">7</div>
                </div>
                <div class="prob-col">
                    <div class="prob-value" id="prob8">0%</div>
                    <div class="prob-bar-container">
                        <div class="prob-bar" id="bar8"></div>
                    </div>
                    <div class="prob-label">8</div>
                </div>
                <div class="prob-col">
                    <div class="prob-value" id="prob9">0%</div>
                    <div class="prob-bar-container">
                        <div class="prob-bar" id="bar9"></div>
                    </div>
                    <div class="prob-label">9</div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const predictionEl = document.getElementById('prediction');
        const confidenceEl = document.getElementById('confidence');
        const statusEl = document.getElementById('status');
        const modelSelect = document.getElementById('modelSelect');
        
        let isDrawing = false;
        let currentTool = 'pen';
        let model = null;
        let drawTimeout = null;
        
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        document.getElementById('penBtn').addEventListener('click', () => {
            currentTool = 'pen';
            document.getElementById('penBtn').classList.add('active');
            document.getElementById('eraserBtn').classList.remove('active');
        });
        
        document.getElementById('eraserBtn').addEventListener('click', () => {
            currentTool = 'eraser';
            document.getElementById('eraserBtn').classList.add('active');
            document.getElementById('penBtn').classList.remove('active');
        });
        
        document.getElementById('clearBtn').addEventListener('click', () => {
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            resetPrediction();
        });
        
        modelSelect.addEventListener('change', (e) => {
            loadModel(e.target.value);
        });
        
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            if (e.touches && e.touches.length > 0) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX,
                    y: (e.touches[0].clientY - rect.top) * scaleY
                };
            }
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }
        
        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const pos = getPos(e);
            
            if (currentTool === 'pen') {
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 20;
            } else {
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 40;
            }
            
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            
            if (drawTimeout) clearTimeout(drawTimeout);
            drawTimeout = setTimeout(() => {
                if (model) predict();
            }, 500);
        }
        
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.beginPath();
            }
        }
        
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchcancel', stopDrawing);
        
        async function loadModel(modelName) {
            statusEl.textContent = 'Chargement...';
            
            try {
                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) throw new Error('WebGPU non disponible');
                const device = await adapter.requestDevice();
                
                const modelModule = await import(`./mnist/${modelName}/${modelName}.js`);
                model = await modelModule.default.load(device, `./mnist/${modelName}/${modelName}.webgpu.safetensors`);
                
                statusEl.textContent = 'Modele charge';
                confidenceEl.textContent = 'Dessinez pour predire';
            } catch (error) {
                statusEl.textContent = 'Erreur: ' + error.message;
            }
        }
        
        async function predict() {
            if (!model) return;
            
            try {
                statusEl.textContent = 'Prediction...';
                const startTime = performance.now();
                
                const inputData = preprocessImage();
                const input = new Float32Array(inputData);
                const output = await model(input);
                
                const inferenceTime = (performance.now() - startTime).toFixed(0);
                
                const logits = Array.from(output[0]).slice(0, 10);
                const probs = softmax(logits);
                const maxIdx = probs.indexOf(Math.max(...probs));
                const confidence = (probs[maxIdx] * 100).toFixed(1);
                
                predictionEl.textContent = maxIdx;
                confidenceEl.textContent = `Confiance: ${confidence}% | ${inferenceTime}ms`;
                statusEl.textContent = 'Prediction effectuee';
                
                updateProbBars(probs);
                
            } catch (error) {
                statusEl.textContent = 'Erreur: ' + error.message;
            }
        }
        
        function preprocessImage() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 28;
            tempCanvas.height = 28;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.imageSmoothingEnabled = false;
            tempCtx.drawImage(canvas, 0, 0, 28, 28);
            
            const imageData = tempCtx.getImageData(0, 0, 28, 28);
            const pixels = imageData.data;
            const normalized = new Array(784);
            
            for (let i = 0; i < 784; i++) {
                const idx = i * 4;
                const gray = (pixels[idx] + pixels[idx + 1] + pixels[idx + 2]) / 3;
                normalized[i] = (gray / 255) * 2 - 1;
            }
            
            return normalized;
        }
        
        function softmax(arr) {
            const max = Math.max(...arr);
            const exps = arr.map(x => Math.exp(x - max));
            const sum = exps.reduce((a, b) => a + b);
            return exps.map(x => x / sum);
        }
        
        function updateProbBars(probs) {
            for (let i = 0; i < 10; i++) {
                const percentage = (probs[i] * 100).toFixed(1);
                document.getElementById(`bar${i}`).style.height = `${percentage}%`;
                document.getElementById(`prob${i}`).textContent = `${percentage}%`;
            }
        }
        
        function resetPrediction() {
            predictionEl.textContent = '-';
            confidenceEl.textContent = model ? 'Dessinez pour predire' : 'Chargement...';
            statusEl.textContent = '';
            for (let i = 0; i < 10; i++) {
                document.getElementById(`bar${i}`).style.height = '0%';
                document.getElementById(`prob${i}`).textContent = '0%';
            }
        }
        
        loadModel('mnist_mlp');
    </script>
</body>
</html>